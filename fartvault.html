<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fart Vault - Pro Trading Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@1.91.4/lib/index.iife.min.js"></script>
    <script>var global = global || window;</script>
    <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/dist/buffer.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@0.4.3/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .vault-panel { background-color: #1f2937; border: 1px solid #374151; box-shadow: 0 0 25px rgba(0, 0, 0, 0.5); }
        .vault-header { font-family: 'Roboto Slab', serif; color: #f3f4f6; }
        .log-entry { font-family: 'Courier New', Courier, monospace; padding: 4px 8px; margin-top: 4px; border-radius: 4px; word-break: break-all; }
        .log-info { background-color: #1e3a8a; color: #93c5fd; }
        .log-success { background-color: #14532d; color: #86efac; }
        .log-error { background-color: #7f1d1d; color: #fca5a5; }
        .log-warn { background-color: #713f12; color: #fcd34d; }
        .disabled-button { cursor: not-allowed; opacity: 0.5; }
        .tab-btn.active { border-color: #fbbf24; background-color: #374151; color: #fbbf24; font-weight: 600; }
        .input-field { background-color: #374151; border-color: #4b5563; color: #e5e7eb; }
        .btn-primary { background-color: #ca8a04; color: #1f2937; font-weight: bold; }
        .btn-primary:hover { background-color: #a16207; }
        .btn-secondary { background-color: #4b5563; color: #d1d5db; }
        .btn-secondary:hover { background-color: #6b7280; }
         #error-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none; align-items: center; justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div id="error-overlay">
        <div class="text-center p-8 bg-red-900/50 border border-red-700 rounded-lg max-w-lg">
            <h2 class="text-2xl font-bold text-red-300 mb-4">Application Failed to Load</h2>
            <p class="text-red-200">The core libraries required to run the Fart Vault could not be downloaded. This is usually caused by network issues or an ad-blocker.</p>
            <p class="mt-4 text-red-200">Please try the following:</p>
            <ul class="list-disc list-inside text-left mt-2 text-red-200">
                <li>Check your internet connection.</li>
                <li>Disable any ad-blockers or privacy extensions for this page.</li>
                <li>Hard-refresh the page (Ctrl+Shift+R or Cmd+Shift+R).</li>
            </ul>
        </div>
    </div>

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Panel: Trade Execution & Settings -->
        <div class="lg:col-span-1 space-y-8">
            <header class="text-center">
                <h1 class="text-5xl vault-header">üè¶ Fart Vault</h1>
                <p class="text-gray-400 mt-2">Your Secure Solana Trading Terminal</p>
            </header>

            <div id="wallet-status" class="vault-panel p-4 rounded-lg text-center">
                 <button id="connectWalletBtn" class="w-full btn-primary py-2 px-4 rounded-md">Connect Phantom</button>
                 <div id="connected-state" class="hidden">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-gray-400 text-left text-sm">Connected Wallet:</p>
                            <p id="walletAddress" class="font-mono text-xs bg-gray-800 p-2 rounded-md truncate"></p>
                        </div>
                        <button id="disconnectWalletBtn" class="text-sm text-yellow-400 hover:underline font-semibold">Disconnect</button>
                    </div>
                 </div>
            </div>
            
            <div class="vault-panel p-6 rounded-lg">
                <h2 class="text-2xl vault-header mb-4">Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label for="rpcEndpoint" class="block text-sm font-medium text-gray-400">RPC Endpoint</label>
                        <select id="rpcEndpoint" class="input-field mt-1 block w-full px-3 py-2 rounded-md">
                            <option value="https://api.mainnet-beta.solana.com">Mainnet (Public)</option>
                        </select>
                    </div>
                    <div>
                        <label for="moralisApiKey" class="block text-sm font-medium text-gray-400">Moralis API Key</label>
                        <input type="password" id="moralisApiKey" class="input-field mt-1 block w-full px-3 py-2 rounded-md" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjdmNDg2ZjlhLWZmNWMtNGEyNi04NTIyLTkzYjhkZTU4ODU5OSIsIm9yZ0lkIjoiNDU1NjM0IiwidXNlcklkIjoiNDY4Nzg4IiwidHlwZUlkIjoiNGIwMmM1ZDMtMmU4Mi00MGZmLWJkNWMtY2JkMTUxMDBiMzUxIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NTA4MTQ4ODQsImV4cCI6NDkwNjU3NDg4NH0.NnPAEYiLiGyR3p647suJWsAEZQ4ufEjDQtT4-SoGnpU">
                    </div>
                </div>
            </div>

            <div class="vault-panel p-6 rounded-lg">
                <div class="mb-4 border-b border-gray-600">
                    <nav class="flex -mb-px">
                        <button id="buyTabBtn" class="tab-btn active w-1/2 py-4 px-1 text-center border-b-2">Buy</button>
                        <button id="sellTabBtn" class="tab-btn w-1/2 py-4 px-1 text-center border-b-2">Sell</button>
                    </nav>
                </div>
                <div id="trade-content">
                    <div id="buy-tab-content" class="space-y-4">
                        <div>
                            <label for="buyTokenAddress" class="block text-sm font-medium text-gray-400">Token to Buy (Address)</label>
                            <input type="text" id="buyTokenAddress" class="input-field mt-1 block w-full px-3 py-2 rounded-md" placeholder="Paste token mint address...">
                        </div>
                        <div>
                            <label for="buySolAmount" class="block text-sm font-medium text-gray-400">Amount of SOL to Spend</label>
                            <input type="number" id="buySolAmount" step="0.01" class="input-field mt-1 block w-full px-3 py-2 rounded-md" placeholder="e.g., 0.1">
                        </div>
                    </div>
                    <div id="sell-tab-content" class="hidden space-y-4">
                        <div>
                            <label for="sellTokenSelect" class="block text-sm font-medium text-gray-400">Your Tokens</label>
                            <div class="flex items-center">
                                <select id="sellTokenSelect" class="input-field mt-1 block w-full px-3 py-2 rounded-l-md"></select>
                                <button id="refreshBalancesBtn" class="p-2.5 mt-1 rounded-r-md hover:bg-gray-600 bg-gray-700">üîÑ</button>
                            </div>
                        </div>
                        <div>
                            <label for="sellTokenAmount" class="block text-sm font-medium text-gray-400">Amount to Sell</label>
                            <div class="flex items-center mt-1">
                                <input type="number" id="sellTokenAmount" step="0.01" class="input-field block w-full px-3 py-2 rounded-l-md">
                                <button id="maxSellBtn" class="px-4 py-2 bg-gray-600 text-gray-300 font-semibold rounded-r-md hover:bg-gray-500">Max</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-4 mt-6 pt-4 border-t border-gray-600">
                    <button id="executeBtn" class="w-full btn-primary py-3 px-4 rounded-md flex items-center justify-center disabled-button" disabled>
                        <span id="executeBtnText">Connect Wallet</span>
                        <svg id="executeSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Token Analytics -->
        <div class="lg:col-span-2 space-y-8">
             <div id="token-info-panel" class="vault-panel p-6 rounded-lg hidden">
                 <div id="token-info-loader" class="text-center hidden">
                    <svg class="animate-spin mx-auto h-8 w-8 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-2 text-gray-400">Fetching token data...</p>
                 </div>
                 <div id="token-info-content" class="hidden">
                    <!-- ... unchanged ... -->
                 </div>
             </div>
            <div class="vault-panel p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                     <h2 class="text-2xl vault-header">Log Console</h2>
                     <button id="clearLogBtn" class="btn-secondary text-xs py-1 px-3 rounded-md">Clear Log</button>
                </div>
                <div id="log" class="h-96 overflow-y-auto bg-gray-900 p-2 rounded-md"></div>
            </div>
        </div>
    </div>

    <script>
        const waitForLibsAndInitialize = (retries = 30) => {
            if (retries === 0) {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('error-overlay').style.display = 'flex';
                return;
            }

            if (typeof solanaWeb3 !== 'undefined' && typeof splToken !== 'undefined' && typeof LightweightCharts !== 'undefined' && typeof buffer !== 'undefined') {
                initializeApp();
            } else {
                setTimeout(() => waitForLibsAndInitialize(retries - 1), 100);
            }
        };

        const initializeApp = () => {
            const elements = { /* ... DOM element references ... */ };
            let provider = null;
            let activeTab = 'buy';
            let tokenBalances = [];
            let chart = null;
            let infoFetchTimeout = null;
            
            const { Connection, PublicKey, VersionedTransaction } = solanaWeb3;
            const Buffer = buffer.Buffer;

            function addLog(message, type = 'info') { /* ... */ }
            function toggleLoading(isLoading) { /* ... */ }
            
            function updateWalletState(connectedProvider) {
                provider = connectedProvider;
                if (provider) {
                    elements.walletAddressP.textContent = provider.publicKey.toBase58();
                    elements.connectWalletBtn.classList.add('hidden');
                    elements.connectedStateDiv.classList.remove('hidden');
                    elements.executeBtn.disabled = false;
                    elements.executeBtn.classList.remove('disabled-button');
                    elements.executeBtnText.textContent = "Execute Trade";
                    fetchTokenBalances();
                } else {
                    elements.connectWalletBtn.classList.remove('hidden');
                    elements.connectedStateDiv.classList.add('hidden');
                    elements.executeBtn.disabled = true;
                    elements.executeBtn.classList.add('disabled-button');
                    elements.executeBtnText.textContent = "Connect Wallet";
                    elements.sellTokenSelect.innerHTML = '<option value="">-- Connect wallet --</option>';
                    tokenBalances = [];
                }
            }
            
            async function fetchTokenBalances() {
                if (!provider?.publicKey) return;
                addLog("Fetching token balances with Moralis...", 'info');
                const apiKey = elements.moralisApiKey.value.trim();
                if (!apiKey) { addLog("Moralis API Key is required.", "warn"); return; }
                try {
                    const response = await fetch(`https://solana-gateway.moralis.io/account/mainnet/${provider.publicKey.toBase58()}/tokens`, {
                        headers: { 'X-API-Key': apiKey, 'accept': 'application/json' }
                    });
                    if (!response.ok) throw new Error(`Moralis API Error: ${response.statusText}`);
                    const data = await response.json();
                    tokenBalances = data.map(token => ({ mint: token.mint, amount: parseFloat(token.amount) / (10 ** token.decimals), decimals: token.decimals, symbol: token.symbol }))
                        .filter(t => t.amount > 0);
                    populateSellDropdown();
                    addLog(`Found ${tokenBalances.length} token(s).`, 'success');
                } catch (error) { addLog(`Failed to fetch Moralis balances: ${error.message}`, 'error'); }
            }

            function populateSellDropdown() { /* ... */ }

            async function executeTrade() {
                if (!provider?.publicKey) {
                    addLog("Please connect your wallet first.", "error"); return;
                }
                if (!window.confirm("Are you sure you want to Fart?")) {
                    addLog("Trade cancelled by user.", "warn"); return;
                }
                toggleLoading(true);

                try {
                    await tradeWithJupiter(activeTab);
                } catch (e) {
                    addLog(`An unexpected error occurred: ${e.message}`, "error");
                } finally {
                    toggleLoading(false);
                    await fetchTokenBalances();
                }
            }
            
            async function tradeWithJupiter(tradeType) {
                 addLog(`Preparing Jupiter ${tradeType}...`, "info");
                 try {
                    const rpcUrl = elements.rpcEndpoint.value;
                    const connection = new Connection(rpcUrl);
                    let inputMint, outputMint, amount;

                    if (tradeType === 'buy') {
                        const solAmount = parseFloat(elements.buySolAmountInput.value);
                        const tokenToBuy = elements.buyTokenAddressInput.value.trim();
                        if (!tokenToBuy || !solAmount || solAmount <= 0) throw new Error("Invalid buy input.");
                        inputMint = 'So11111111111111111111111111111111111111112';
                        outputMint = tokenToBuy;
                        amount = Math.floor(solAmount * solanaWeb3.LAMPORTS_PER_SOL);
                    } else { // Sell
                        const tokenToSell = elements.sellTokenSelect.value;
                        const amountToSell = parseFloat(elements.sellTokenAmountInput.value);
                        const tokenInfo = tokenBalances.find(t => t.mint === tokenToSell);
                        if (!tokenInfo || !amountToSell || amountToSell <= 0) throw new Error("Invalid sell input.");
                        inputMint = tokenToSell;
                        outputMint = 'So11111111111111111111111111111111111111112';
                        amount = Math.floor(amountToSell * (10 ** tokenInfo.decimals));
                    }
                    
                    addLog("Getting quote from Jupiter...", "info");
                    const quoteUrl = `https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=500`;
                    const quoteResponse = await fetch(quoteUrl).then(res => res.json());

                    addLog("Fetching swap transaction...", "info");
                    const swapResponse = await fetch('https://quote-api.jup.ag/v6/swap', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quoteResponse, userPublicKey: provider.publicKey.toBase58(), wrapAndUnwrapSol: true })
                    }).then(res => res.json());

                    const swapTransactionBuf = Buffer.from(swapResponse.swapTransaction, 'base64');
                    const transaction = VersionedTransaction.deserialize(swapTransactionBuf);
                    
                    addLog("Awaiting signature from wallet...", "info");
                    const signedTransaction = await provider.signTransaction(transaction);
                    
                    addLog("Sending transaction...", "info");
                    const txid = await connection.sendRawTransaction(signedTransaction.serialize(), { skipPreflight: true });
                    
                    addLog(`Transaction sent! Signature: ${txid}`, "success");
                    await connection.confirmTransaction(txid, 'confirmed');
                    addLog(`‚úÖ ${tradeType.charAt(0).toUpperCase() + tradeType.slice(1)} confirmed! View on Solscan: https://solscan.io/tx/${txid}`, "success");
                 } catch (error) {
                    addLog(`Jupiter ${tradeType} failed: ${error.message}`, "error");
                 }
            }
            
            const getProvider = () => {
                if ('phantom' in window && window.phantom.solana?.isPhantom) return window.phantom.solana;
                return null;
            };

            const initializeApp = () => {
                // ... setup event listeners ...
                const phantomProvider = getProvider();
                if (phantomProvider) {
                    phantomProvider.on("connect", () => updateWalletState(phantomProvider));
                    phantomProvider.on("disconnect", () => updateWalletState(null));
                    if (phantomProvider.isConnected) {
                        updateWalletState(phantomProvider);
                    }
                }
                 addLog("Fart Vault Initialized. Please connect your wallet.", "info");
            };

            initializeApp();
        };
        
        window.onload = waitForLibsAndInitialize;
    </script>
</body>
</html>
